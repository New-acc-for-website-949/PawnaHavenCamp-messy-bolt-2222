## âœ… ARCHITECTURE REFACTOR DIRECTIVE (CTO DECISION)

After reviewing the current codebase and recent issues (cross-contamination between Villas and Campings_Cottages logic), we are **officially approving an architecture refactor** before launch.

---

## ğŸ”¹ KEY DECISIONS (FINAL)

### 1ï¸âƒ£ Separate Backend Controllers by Property Type

**YES â€” This is mandatory**

Current issue:

* `propertyController.js` is 1000+ lines
* Heavy use of `if (category === 'villa')` logic
* Changes in one flow break the other

### New Controller Structure (MANDATORY)

```txt
backend/controllers/
â”œâ”€â”€ shared/
â”‚   â””â”€â”€ basePropertyController.js   // shared read-only/common logic
â”œâ”€â”€ villa/
â”‚   â””â”€â”€ villaController.js          // villas ONLY
â””â”€â”€ camping/
    â””â”€â”€ camping_CottagesController.js        // campings_cottages ONLY
```

**Rules**

* `villaController.js` must NEVER contain unit logic
* `camping_CottagesController.js` must NEVER contain villa logic
* No category conditionals inside controllers

---

### 2ï¸âƒ£ Unique `calendar_id` for Every Calendar Row

**YES â€” Required**

Current:

* `availability_calendar`: property_id + date
* `unit_calendar`: unit_id + date

### Change Required

* Add a **unique `calendar_id` (UUID or SERIAL)** to both tables

**Benefits**

* Cleaner APIs (single ID instead of composite keys)
* Easier debugging & tracking
* Enables future calendar sync, exports, and audit logs

---

### 3ï¸âƒ£ Separate API Routes for Villas & Campings

**YES â€” Enforced**

### New Route Structure

```txt
backend/routes/
â”œâ”€â”€ villa.js      â†’ /api/villa/*
â””â”€â”€ camping_Cottage.js    â†’ /api/camping_Cottages/*
```

**Rules**

* No mixed routes
* No category checks inside route handlers
* Each dashboard talks ONLY to its own API namespace

---

## ğŸ”¹ 5 CRITICAL PRE-LAUNCH CHANGES

| # | Change                                | Reason                         |
| - | ------------------------------------- | ------------------------------ |
| 1 | Separate controllers by property type | Prevent logic bleed            |
| 2 | Unique calendar_id                    | Clean APIs & tracking          |
| 3 | Separate API namespaces               | Clear ownership & stability    |
| 4 | Add structured error handling         | Debug faster, safer production |
| 5 | Input validation middleware           | Prevent bad data entering DB   |

---

## ğŸ”¹ ERROR HANDLING REQUIREMENT

Replace generic `500 Internal Server Error` with:

* 400 â†’ Validation errors
* 404 â†’ Not found
* 409 â†’ Booking / availability conflicts
* 500 â†’ True server errors

---

## ğŸ”¹ INPUT VALIDATION (MANDATORY)

Add validation middleware:

* Property ID
* Unit ID
* Dates
* Capacity values
* Prices
* Booking payloads

**Validation must run BEFORE controller logic**

---

## ğŸ”¹ QUICK WIN ARCHITECTURE (FINAL TARGET)

```txt
backend/
â”œâ”€â”€ controllers/
â”‚   â”œâ”€â”€ shared/
â”‚   â”‚   â””â”€â”€ basePropertyController.js
â”‚   â”œâ”€â”€ villa/
â”‚   â”‚   â””â”€â”€ villaController.js
â”‚   â””â”€â”€ camping/
â”‚       â””â”€â”€ camping_CottagesController.js
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ villa.js
â”‚   â””â”€â”€ camping_Cottages.js
â”œâ”€â”€ middlewares/
â”‚   â”œâ”€â”€ validateInput.js
â”‚   â””â”€â”€ errorHandler.js
```

---

## ğŸš« NON-NEGOTIABLE RULES

* Villas logic must remain 100% untouched by camping changes
* Campings_Cottages must remain unit-based
* No category-based branching inside controllers
* Any shared logic goes ONLY into `shared/`

---

**Proceed step-by-step.
Start with controller & route separation first.
Wait for approval after structural refactor before touching business logic.**

---